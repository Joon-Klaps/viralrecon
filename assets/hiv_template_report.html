<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HIV Resistance Report</title>
    <style>
      {{ css_content | safe }}
    </style>
  </head>
  <body>
    <!-- Fixed dropdown for sample navigation -->
    <select id="sample-selector" onchange="scrollToSample(this.value)">
      <option value="">Select sample</option>
      {% for sample in all_samples %}
      <option value="sample_{{ loop.index }}">{{ loop.index }}. {{ sample.sample_name }}</option>
      {% endfor %}
    </select>

    <script>
      function scrollToSample(id) {
        if (id) {
          const element = document.getElementById(id);
          if (element) element.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }
    </script>

    {% for sample in all_samples %}
    <!-- HEADER -->
    <div class="header" id="sample_{{ loop.index }}">{{ loop.index }}. {{ sample.sample_name }}</div>

    <!-- SEQUENCE SUMMARY -->
    <div class="summary-title">
      <h2>Sequence Summary</h2>
    </div>

    <div class="sequence-summary-info">
      <ul>
        {% for line in sample.sequence_summary %}
        <li>{{ line }}</li>
        {% endfor %}
      </ul>
    </div>

    {% for gene in ["PR", "RT", "IN"] %} {% set gene_mutations = sample.mutation_data | selectattr("Gene_name",
    "equalto", gene) | list %} {% set gene_resistances = sample.resistance_data | selectattr("Gene_name", "equalto",
    gene) | list %} {% if gene_mutations or gene_resistances %}
    <div class="summary-title">
      <h2>Drug resistance interpretation: {{ gene }}</h2>
    </div>

    <div class="content-block">
      <!-- MUTATIONS -->
      {% for mut_type, mut_label in [ ("Major", "Major Mutations"), ("Accessory", "Accessory Mutations"), ("Other",
      "Other Mutations") ] %} {% set mut_list = gene_mutations | selectattr("Mutations_type", "equalto", mut_type) |
      list %}
      <p><strong>{{ mut_label }}:</strong> {% if not mut_list %}None{% endif %}</p>

      {% if mut_list %}
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Mutation</th>
              <th>AF (%)</th>
              <th>Coverage</th>
            </tr>
          </thead>
          <tbody>
            {% for row in mut_list %}
            <tr>
              <td>{{ row.Mutations }}</td>
              <td>{{ (row.Mutation_AF | float * 100) | round(2) }}</td>
              <td>{{ row.Coverage }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %} {% endfor %}

      <!-- RESISTANCE -->
      {% if gene_resistances %} {% for drug_class, class_label in [ ("PI", "Protease Inhibitors"), ("NRTI", "Nucleoside
      Reverse Transcriptase Inhibitors"), ("NNRTI", "Non-nucleoside Reverse Transcriptase Inhibitors"), ("INSTI",
      "Integrase Strand Transfer Inhibitors") ] %} {% set class_drugs = gene_resistances | selectattr("Drug_class",
      "equalto", drug_class) | list %} {% if class_drugs %}
      <h3>{{ class_label }}</h3>
      <hr />
      <div class="table-scroll">
        <table>
          <tbody>
            {% for row in class_drugs %}
            <tr>
              <td>{{ row.Drug_name }}</td>
              <td>{{ row.Res_status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %} {% endfor %} {% endif %}
    </div>
    {% endif %}

    <!-- COMMENTS -->
    {% set comment_list = [] %} {% for m in gene_mutations %} {% if m.Mutations_comments and
    m.Mutations_comments|string|lower not in ["nan", "none", ""] %} {% set _ = comment_list.append(m) %} {% endif %} {%
    endfor %} {% if comment_list %}
    <div class="mutation-comments">
      <strong>{{ gene }} comments</strong>
      <ul>
        {% for row in comment_list %}
        <li>{{ row.Mutations }}: {{ row.Mutations_comments }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %} {% endfor %}

    <!-- CONSENSUS GENOME -->
    <div class="summary-title">
      <h2>Consensus Genome</h2>
    </div>

    {% if sample.consensus_genome %}
    <div class="content-block">
      <details>
        <summary>Show consensus genome</summary>
        <pre>{{- sample.consensus_genome -}}</pre>
      </details>
    </div>
    {% else %}
    <p>No consensus genome available</p>
    {% endif %} {% endfor %}

    <!-- FOOTER -->
    <div class="footer">
      <p>Generated automatically from nf-core/viralrecon using sierra-local and codfreq data.</p>
    </div>
  </body>
</html>
